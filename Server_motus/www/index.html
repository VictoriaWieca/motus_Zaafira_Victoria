<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8"> 
      <style>
          table,
          th,
          td {
              padding: 10px;
              border: 1px solid white;
              border-collapse: collapse;
          }
      </style>
  </head>
  
  <body>
    <script src="https://code.jquery.com/jquery-3.6.1.js" 
      integrity="sha256-3zlB5s2uwoUzrXK3BT7AX3FyvojsraNFxCc2vC/7pNI=" 
      crossorigin="anonymous">
    </script>

    <button id="logout">Log Out</button>

    <a href="http://localhost:3001/score.html">Score</a>

    <h2> Player : <span id="myName"></span> </h2>
    <form id="proposition">
      <label for="fname">Your guess :</label><br>
      <input type="text" id="response" name="response" value=""><br>
      <input type="submit" id="submit" value="Valider" >
    </form>
  
    <div id="table_motus"></div>

    <button  id='play-again' style="visibility: hidden;" onclick="playAgain()">Play again</button>

    <script>
        function playAgain(){

          $("#response").val('');
          window.location.reload();
        }

       /* if(localStorage.getItem("name")===null){
          window.location = "http://localhost:5000/login.html"; 
        }
        pseudo = localStorage.getItem("name");
        $("#myName").html(pseudo);*/
        

        var myWin=0;
        var name= "";
        var isConnected = 0;
        console.log(`debut : ${myWin}`);

        $.get("/session", function( data ) {
          $(document).ready(function(){
              $("#logout").on("click",function(e){
                console.log("test logout")
                e.preventDefault();
                isConnected=0;
                window.location="/logOut";
                $.post("http://localhost:5000/logged", {connected:0})
              }); 
            })
          if(data==='' || data===null){
            isConnected=0;
            $.post("http://localhost:5000/logged", {connected:isConnected})
            window.location = "http://localhost:5000/login.html"; 
          }else{
            isConnected=1;
            $.post("http://localhost:5000/logged", {connected:isConnected})
            $("#myName").html(data);
          }
        })

        word_of_today = "";
        number_of_letters = 0;
        nbEssai=0;

        $.get("/word", function( data ) {
          word_of_today = data.trim();
          number_of_letters = word_of_today.length;
          addTable(number_of_letters);
          $("#response").attr("maxlength",word_of_today.length)
          $("#response").attr("minlength",word_of_today.length)
          $("form").on("submit", function (e) {
            e.preventDefault();
            compare()
        }); 
        });
        
        function build(mot){
          number_of_letters = mot.length;

          console.log(`number of letters : ${number_of_letters}`)
        }

        function compare(){
          answer = $("#response").val();
          console.log(answer+"-"+word_of_today);

          if(answer.length!=word_of_today.length){
            alert(`Le mot doit avoir ${word_of_today.length} lettres`)
          }
          else{
            if(answer== word_of_today){
              alert(`Le mot du jour est bien ${word_of_today}`);
              myWin="ok";
              console.log(`win : ${myWin}`);
              $.post("http://localhost:3001/score", {myWin:1, name:name});
              document.getElementById('play-again').style.visibility = 'visible';

              document.getElementById('proposition').style.visibility = 'hidden';
            }
            else{
                $("#response").val('');
                myWin="pasok";
                console.log(`pas win: ${myWin}`);
                $.post("http://localhost:3001/score", {myWin:0, name:name});
            }
          
            if(nbEssai>=10){
              alert(`Vous avez PERDU `);
              $("#response").val('')
              window.location.reload();
            }
            else{
              fillTable(answer,nbEssai);
              nbEssai=nbEssai+1;
            }
          }
          return false;
        
        }

        function fillTable(answer,i){
          var arrayLignes = document.getElementById("myTable").rows; //on récupère les lignes du tableau
          var longueur = arrayLignes.length;
          answer_array = answer.toUpperCase().trim();
          console.log(answer_array);
          word_of_today_array = word_of_today.toUpperCase().trim();

              var arrayColonnes = arrayLignes[i].cells;//on récupère les cellules de la ligne
              var largeur = arrayColonnes.length;
              for(var j=0; j<largeur; j++){
                arrayColonnes[j].innerHTML = answer_array[j];
                if(answer_array[j] == word_of_today_array[j]){
                  arrayColonnes[j].style.backgroundColor = "green";
                }else if(word_of_today_array.includes(answer_array[j])){
                  arrayColonnes[j].style.backgroundColor = "orange";
                }else{
                  arrayColonnes[j].style.backgroundColor = "blue";
                }
              }
            
        }

        /*$(document).keypress(function(e) {
            if(e.which == 13) {
                e.preventDefault();
                compare();
            }
        });*/

        $("#response").focus()
          
        
        function addTable(nbLetters) {
          var myTableDiv = document.getElementById("table_motus");
          var table = document.createElement('TABLE');
          table.setAttribute('id', 'myTable')
          table.border = '1';
          var tableBody = document.createElement('TBODY');
          table.appendChild(tableBody);
          for (var i = 0; i < 10; i++) {
            var tr = document.createElement('TR');
            tableBody.appendChild(tr);
            for (var j = 0; j < nbLetters; j++) {
              var td = document.createElement('TD');
              td.width = '35';
              td.height = '35';
              td.style.backgroundColor = 'blue';
              tr.appendChild(td);
            }
          }
          myTableDiv.appendChild(table);
        }
       

      </script>


  </body>
</html>